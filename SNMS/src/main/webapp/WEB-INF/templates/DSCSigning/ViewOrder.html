<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layout/layout" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">


<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Preview Order</title>
</head>

<body>

	<div layout:fragment="content">
		<div class="row pt-2 pb-2">
			<div class="col-sm-8">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="">Home</a></li>
					<li class="breadcrumb-item active" aria-current="page">Preview
						Order</li>
				</ol>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-body">
					<div th:if="${regDscmsg}"><span th:text="${regDscmsg}" class="text-danger"></span></div>
					<div th:if="${isValidDsc}"><span th:text="${isValidDsc}" class="text-danger"></span></div>
					
					<div class="form-group row">
						<div class="col-md-7">
							<iframe th:src="${session.unSignDocdinPre}" width="700px"
								height="600px" id="iframefile" hidden="true" ></iframe>
								<iframe th:src="${session.unSignDocPre}" width="700px"
								height="600px" id="iframefile2"></iframe>
						</div>
						<div class="col-md-5">
							<form th:action="@{esignOrder}" method="post">
								<input type="hidden" th:name="id" th:value="${id}"  id="ooid"/>
								<span th:if="${!isLegacy}">
<!-- 								<input type="submit" value="e-Sign with DSC" class="btn btn-danger"> -->
								<input type="button" value="e-Sign" class="btn btn-danger" onclick="displayeSignBlock();"><br></span>
								<span th:if="${!isLegacy}">
								<a href="approvedOrders" class="btn btn-success"> << Back To Approved Order</a></span>
								<span th:if="${isLegacy}">
								<a href="approvedLegacyOrders" class="btn btn-success"> << Back To Approved Order</a></span>
								<span style="display:none;color:blue" id="esignBlock" >
										<p>I hereby state that I have no objection in
											authenticating myself with Aadhaar based authentication
											system and consent to providing my Aadhaar number, Biometric
											and/or One Time Pin (OTP) data for Aadhaar based
											authentication from UIDAI, for the purposes of availing of
											eSign Services from eSign Provider (C-DAC) through NIC-eSign
											Gateway service and consumed in Summon and Notices Management System from 
											SFIO Division of National Informatics Centre as
											Application Service Provider.</p>
										<p>I understand that the Biometrics and/or OTP I provide
											for authentication shall be used only for authenticating my
											identity through the Aadhaar Authentication system, for
											obtaining my e-KYC through Aadhaar e-KYC service and for the
											issuance of Digital Signature Certificate (DSC) for this
											specific transaction and for no other purposes. For the
											creation of DSC, I understand that the options that I have
											chosen are the ones that shall be populated in the DSC
											generated by the CA (C-DAC) and I provide my consent for the
											same. I also understand that the following fields in the DSC
											generated by the CA (C-DAC) are mandatory and I give my
											consent for using the Aadhaar provided e-KYC information to
											populate the corresponding fields in the DSC.</p>
										<ul style="list-style-type: none;">
											<li>Common Name (name as obtained from e-KYC)</li>
											<li>Unique Identifier (hash of Aadhaar number)</li>
											<li>Pseudonym (unique code sent by UIDAI in e-KYC
												response)</li>
											<li>State or Province (state as obtained from e-KYC)</li>
											<li>Postal Code (postal code as obtained from e-KYC)</li>
											<li>Telephone Number (hash of phone as obtained from
												e-KYC)</li>
											<li><input type="checkbox" name="consent" id="consent"
												style="outline: 2px solid #c00;" /> &nbsp;&nbsp; I understand that SFIO
												Division of National Informatics Centre shall ensure
												security and confidentiality of my personal identity data
												provided for the purpose of Aadhaar based authentication.</li>
										</ul> <input type="button" value="Proceed to e-Sign" class="btn btn-primary" id="signButton" onclick="proceedToSign();" disabled="disabled"/>
								</span>
							</form>
						
						<!-- <form method="post" id="genHash" th:action="@{/esignPdf}">
							<input id="aadhar1" name="name" type="hidden" />
							<input id="docName" name="fileName" type="hidden" />
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
						</form>	 -->
							
<!-- 			<form method="post" id="redirectGateway" action="https://nic-esigngateway.nic.in/eSign21/acceptClient"> -->
<form method="post" id="redirectGateway" action="https://nic-esign2gateway.nic.in/esign/acceptClient">
				<input id="xml" name="xml" type="hidden" /> 
				<input id="clientrequestURL" name="clientrequestURL" value="http://localhost:9090/SNMS/hello1" type="hidden" />
				<input id="username" name="username" value="Shiv" type="hidden" />
				<input type="hidden" name="clientId" value="1" />
	         	<input type="hidden" name="userId" value="2" />
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
			</form>
							
						</div>
						</div>
					</div>
				</div>
			</div>
			
			<script th:inline="javascript">
			
			$('#consent').change(function(){
				 if(this.checked) {
					$('#signButton').attr("disabled",false);
			        }else{
			        	$('#signButton').attr("disabled","disabled");
			        }
			});
			
			function displayeSignBlock(){
				$('#esignBlock').show();
			}
			function proceedToSign(){
// 				var name = $('#aadhar').val();
				var fileName = $('#iframefile').attr('src').substring($('#iframefile').attr('src').lastIndexOf('/')+1);
				var ooid = $('#ooid').val();
// 				$("#genHash").submit();

				var token = [[${_csrf.token}]];
	 			var header = [[${_csrf.headerName}]];

				$(document).ajaxSend(function(e, xhr, options)
						{
						    xhr.setRequestHeader(header, token);
						}), 
						$.ajax({
//					 		 crossDomain: true,
						        type: "POST",
						        url: "esignPdf",
//					 	        contentType : "application/json; charset=utf-8",
								data:{
								        	'name':'dummy',
								        	'fileName':fileName,
								        	'ooid':ooid,
								        	'docType':'order'
								       },
						        cache: false,
						        timeout: 600000,
						        success: function(data){
						        	$('#xml').val(data);
						        	console.log(data);
						        	$("#redirectGateway").submit();
						        	interval = setInterval(removeDiv,1000);
						        	},
						        	
						 error : function(xhr, status, error) {
					        alert('error in Signing');
					      }
						 });

			}
			
			function removeDiv(){
				$('div').removeClass('loading');
		    	 clearInterval(interval); 
			}
			</script>
			
		</div>
	</div>